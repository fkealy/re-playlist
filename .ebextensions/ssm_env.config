files:
  "/tmp/ssm_env.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      REGION=eu-west-2
      PARAMETERS=("APP_NAME" "redirect_uri" "client_id", "client_secret")
      
      for key in ${PARAMETERS[@]}; do
        value=$(aws ssm get-parameter --name $key --region $REGION --with-decryption --query "Parameter.Value" --output text)
        echo "Adding $key=$value to /tmp/env.list"
        echo "$key=$value" >> /tmp/env.list
      done
      
      ENV_FILE_PATH="/var/app/staging/packages/server/.env"
      sed -i "s|__ENV_FILE_PATH__|$ENV_FILE_PATH|g" /var/app/current/docker-compose.eb.yml

container_commands:
  01_copy_env_file:
    command: "cp /tmp/env.list /var/app/staging/packages/server/.env"
    leader_only: true
